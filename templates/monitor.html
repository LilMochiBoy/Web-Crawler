{% extends "base.html" %}

{% block title %}Monitor Crawl - Web Crawler{% endblock %}

{% block content %}
<div class="p-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2 mb-0">
                <i class="fas fa-eye"></i> Live Crawl Monitor
            </h1>
            <p class="text-muted">Real-time monitoring for: <strong>{{ crawl_info.url }}</strong></p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
            <form method="POST" action="{{ url_for('stop_crawl', crawl_id=crawl_id) }}" class="d-inline ms-2">
                <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to stop this crawl?')">
                    <i class="fas fa-stop"></i> Stop Crawl
                </button>
            </form>
        </div>
    </div>
    
    <!-- Progress Bar -->
    <div class="progress-container mb-4">
        <h5><i class="fas fa-chart-line"></i> Progress</h5>
        <div class="progress mb-3" style="height: 25px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 id="crawl-progress"
                 style="width: 0%">
                <span id="progress-text">0%</span>
            </div>
        </div>
        <div class="row text-center">
            <div class="col">
                <small class="text-muted">
                    <span id="pages-processed">0</span> / {{ crawl_info.max_pages }} pages
                </small>
            </div>
            <div class="col">
                <small class="text-muted">
                    Status: <span id="crawl-status" class="fw-bold text-info">{{ crawl_info.status }}</span>
                </small>
            </div>
        </div>
    </div>
    
        <!-- Live Statistics -->
        <div class="live-stats mb-4">
            <div class="live-stat-card">
                <div class="live-stat-number" id="stat-pages-crawled">{{ crawl_info.pages_crawled or 0 }}</div>
                <div class="live-stat-label">Pages Crawled</div>
            </div>
            <div class="live-stat-card">
                <div class="live-stat-number" id="stat-pages-found">{{ crawl_info.pages_found or 0 }}</div>
                <div class="live-stat-label">Pages Found</div>
            </div>
            <div class="live-stat-card">
                <div class="live-stat-number" id="stat-errors">{{ crawl_info.errors or 0 }}</div>
                <div class="live-stat-label">Errors</div>
            </div>
            <div class="live-stat-card">
                <div class="live-stat-number" id="stat-speed">0.0</div>
                <div class="live-stat-label">Pages/sec</div>
            </div>
            <div class="live-stat-card">
                <div class="live-stat-number" id="stat-data-size">0 MB</div>
                <div class="live-stat-label">Data Size</div>
            </div>
            <div class="live-stat-card">
                <div class="live-stat-number" id="stat-elapsed">0s</div>
                <div class="live-stat-label">Elapsed</div>
            </div>
        </div>
    
    <!-- Current Activity -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="progress-container">
                <h5><i class="fas fa-globe"></i> Current Activity</h5>
                <div id="current-url" class="mb-2">
                    <small class="text-muted">Current URL:</small><br>
                    <code id="current-url-text">{{ crawl_info.current_url or 'Waiting...' }}</code>
                </div>
                <div id="activity-log" class="bg-light p-3 rounded" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.9em;">
                    <div class="text-muted">Crawl started...</div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="progress-container">
                <h5><i class="fas fa-cogs"></i> Configuration</h5>
                <table class="table table-sm">
                    <tr>
                        <td><strong>Target URL:</strong></td>
                        <td>{{ crawl_info.url or 'N/A' }}</td>
                    </tr>
                    <tr>
                        <td><strong>Max Pages:</strong></td>
                        <td>{{ crawl_info.max_pages or 'N/A' }}</td>
                    </tr>
                    <tr>
                        <td><strong>Workers:</strong></td>
                        <td>{{ crawl_info.workers or 'N/A' }}</td>
                    </tr>
                    <tr>
                        <td><strong>Delay:</strong></td>
                        <td>{{ crawl_info.delay or 0 }}s</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Performance Chart -->
    <div class="row">
        <div class="col">
            <div class="chart-container">
                <h5><i class="fas fa-chart-area"></i> Performance Chart</h5>
                <canvas id="performanceChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Template data injection -->
<script id="crawl-data" type="application/json">
{
    "crawl_id": "{{ crawl_id }}",
    "start_time": {{ (crawl_info.start_time or 0)|int }},
    "max_pages": {{ (crawl_info.max_pages or 100)|int }},
    "initial_data": {
        "pages_crawled": {{ (crawl_info.pages_crawled or 0)|int }},
        "pages_found": {{ (crawl_info.pages_found or 0)|int }},
        "errors": {{ (crawl_info.errors or 0)|int }},
        "status": "{{ crawl_info.status or 'unknown' }}",
        "current_url": "{{ (crawl_info.current_url or '')|replace('"', '\\"') }}",
        "data_size": {{ (crawl_info.data_size or 0)|int }}
    }
}
</script>

<script>
    // Parse template data
    const templateData = JSON.parse(document.getElementById('crawl-data').textContent);
    const crawlId = templateData.crawl_id;
    const crawlStartTime = templateData.start_time;
    const maxPages = templateData.max_pages;
    let lastUpdate = Date.now();
    
    // Initialize Socket.IO connection
    let socket;
    try {
        socket = io();
    } catch (e) {
        console.log('Socket.IO not available, using polling fallback');
        socket = null;
    }
    
    // Performance chart
    const ctx = document.getElementById('performanceChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Pages Crawled',
                data: [],
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Errors',
                data: [],
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Time'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Count'
                    },
                    beginAtZero: true
                }
            }
        }
    });
    
    // Subscribe to crawl updates
    if (socket) {
        socket.emit('subscribe_crawl', {crawl_id: crawlId});
        
        // Handle real-time updates
        socket.on('crawl_update', function(data) {
            if (data.crawl_id === crawlId) {
                updateDisplay(data.data);
            }
        });
        
        socket.on('crawl_complete', function(data) {
            if (data.crawl_id === crawlId) {
                updateDisplay(data.data);
                addActivityLog('Crawl completed successfully!', 'success');
            }
        });
        
        socket.on('crawl_error', function(data) {
            if (data.crawl_id === crawlId) {
                addActivityLog('Error: ' + data.error, 'error');
                document.getElementById('crawl-status').textContent = 'Error';
                document.getElementById('crawl-status').className = 'fw-bold text-danger';
            }
        });
    } else {
        addActivityLog('Real-time updates not available - using polling');
    }
    
    function updateDisplay(crawlData) {
        // Update progress bar
        const progress = Math.min((crawlData.pages_crawled / maxPages) * 100, 100);
        document.getElementById('crawl-progress').style.width = progress + '%';
        document.getElementById('progress-text').textContent = progress.toFixed(1) + '%';
        
        // Update pages processed
        document.getElementById('pages-processed').textContent = crawlData.pages_crawled;
        
        // Update status
        document.getElementById('crawl-status').textContent = crawlData.status;
        document.getElementById('crawl-status').className = 'fw-bold text-' + 
            (crawlData.status === 'completed' ? 'success' : 
             crawlData.status === 'error' ? 'danger' : 'info');
        
        // Update live stats
        document.getElementById('stat-pages-crawled').textContent = crawlData.pages_crawled || 0;
        document.getElementById('stat-pages-found').textContent = crawlData.pages_found || 0;
        document.getElementById('stat-errors').textContent = crawlData.errors || 0;
        
        // Calculate speed
        const elapsed = (Date.now() / 1000) - crawlStartTime;
        const speed = elapsed > 0 ? (crawlData.pages_crawled / elapsed).toFixed(2) : '0.0';
        document.getElementById('stat-speed').textContent = speed;
        
        // Update data size
        document.getElementById('stat-data-size').textContent = formatBytes(crawlData.data_size || 0);
        
        // Update elapsed time
        document.getElementById('stat-elapsed').textContent = formatDuration(elapsed);
        
        // Update current URL
        if (crawlData.current_url) {
            document.getElementById('current-url-text').textContent = crawlData.current_url;
            addActivityLog('Processing: ' + crawlData.current_url);
        }
        
        // Update chart
        const now = new Date().toLocaleTimeString();
        chart.data.labels.push(now);
        chart.data.datasets[0].data.push(crawlData.pages_crawled || 0);
        chart.data.datasets[1].data.push(crawlData.errors || 0);
        
        // Keep only last 20 data points
        if (chart.data.labels.length > 20) {
            chart.data.labels.shift();
            chart.data.datasets[0].data.shift();
            chart.data.datasets[1].data.shift();
        }
        
        chart.update('none');
        
        lastUpdate = Date.now();
    }
    
    function addActivityLog(message, type) {
        type = type || 'info';
        const log = document.getElementById('activity-log');
        const time = new Date().toLocaleTimeString();
        const color = type === 'error' ? 'text-danger' : 
                     type === 'success' ? 'text-success' : 'text-muted';
        
        const entry = document.createElement('div');
        entry.className = color;
        entry.innerHTML = '<span class="text-muted">[' + time + ']</span> ' + message;
        
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
        
        // Keep only last 50 entries
        while (log.children.length > 50) {
            log.removeChild(log.firstChild);
        }
    }
    
    // Periodic status check (fallback if websockets fail)
    setInterval(function() {
        fetch('/api/crawl_status/' + crawlId)
            .then(response => response.json())
            .then(data => {
                if (!data.error && Date.now() - lastUpdate > 5000) {
                    updateDisplay(data);
                }
            })
            .catch(error => console.error('Error checking crawl status:', error));
    }, 2000);
    
    // Initialize
    addActivityLog('Monitoring started');
    
    // Use initial data from template
    updateDisplay(templateData.initial_data);
</script>
{% endblock %}